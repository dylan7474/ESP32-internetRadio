#!/usr/bin/env bash
set -e

missing=()

check_cmd() {
  if ! command -v "$1" >/dev/null 2>&1; then
    echo "Missing required tool: $1"
    missing+=("$1")
  fi
}

check_lib() {
  local lib="$1"
  if ! grep -Fq "$lib" <<<"$lib_list"; then
    echo "Missing required library: $lib"
    missing+=("$lib")
  fi
}

check_cmd arduino-cli
check_cmd make

if command -v arduino-cli >/dev/null 2>&1; then
  lib_list="$(arduino-cli lib list)"
  if ! arduino-cli core list | grep -Fq 'esp32:esp32'; then
    echo "Missing required core: esp32:esp32"
    missing+=("esp32:esp32 core")
  fi
  for lib in \
    "SimpleRotary" \
    "Adafruit GFX Library" \
    "Adafruit SH110X" \
    "WiFiManager" \
    "ESP32-audioI2S" \
    "ArduinoJson" \
    "StreamUtils"
  do
    check_lib "$lib"
  done
else
  echo "arduino-cli not found; skipping core and library checks"
fi

if [ ${#missing[@]} -ne 0 ]; then
  echo
  echo "The following components are missing:"
  for m in "${missing[@]}"; do
    echo "  - $m"
  done
  echo
  echo "Install Arduino CLI from https://arduino.github.io/arduino-cli/latest/installation/"
  echo "Then run:"
  echo "  arduino-cli core install esp32:esp32"
  echo "  arduino-cli lib install SimpleRotary \"Adafruit GFX Library\" Adafruit_SH110X WiFiManager ESP32-audioI2S ArduinoJson StreamUtils"
  exit 1
else
  echo "All required tools, cores and libraries are available."
  echo "Configuration complete. Run 'make' to build."
fi
